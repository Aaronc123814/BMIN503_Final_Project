---
title: "BMIN503/EPID600 Project Template"
author: "Your Name"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers.

### Overview
Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

The project’s main aim is to develop visualizations that depicts cases and deaths associated with countries that have been most impacted by COVID. In addition, it also seeks to develop machine learning models that predict deaths and cases in the future and simulations that contrast how early prevention techniques could have created different outcomes.

### Introduction 
Describe the problem addressed, its significance, and some background to motivate the problem.

Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

COVID-19 has consumed the lives of many Americans for the past couple months of 2020. Although it was at one point in time contained within the Wuhan Province of China, COVID-19 has spread from a couple dozen cases to more than millions worldwide. Still, citizens are not aware at how drastic such changes took place within the given time frame of 9 months and how COVID impacts different countries differently. The project seeks to educate individuals about COVID-19 such that they can observe trends in the past previous months and into the future. Using machine learning models, the final project aims to change the behavior of citizens such that they can make better decisions regarding to social distancing and lower the impact the virus has upon our communities. Although the project is heavily related to epidemiology, it also relies on interdisciplinary fields that range from biostatistics to computer programming, specifically R. In order to create effect models that predict trends in cases and deaths, one has to be familiar with a variety of mathematical algorithms and machine learning techniques to simulate outcomes. From speaking with faculty within Penn’s campus, it becomes clear that such a task is not facile and requires a the developer to control for a variety of parameters which include latency period, infectious period, time to recovery, and mortality rate just to mention a few. Still, with the help of experts, the projection is one that is worth while to create.


### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

```{r, eval=FALSE}
# 
install.packages("coronavirus")
#install.packages("devtools")
devtools::install_github("RamiKrispin/coronavirus")
install.packages("coronavirus")
install.packages("devtools")
devtools::install_github("RamiKrispin/coronavirus")
install.packages("EpiModel")
install.packages("gt")
install.packages("DiagrammeR")
install.packages("tictoc")
install.packages("incidence")
install.packages("earlyR")
install.packages("rnaturalearth")

```

```{r, eval=FALSE}

library(dplyr)
library(ggplot2)
library(coronavirus)
library(tidyverse)
library(devtools)
library(rnaturalearth)
library(sf)
covid19_df <- refresh_coronavirus_jhu()
update_dataset()
library(RColorBrewer)
library(leaflet)

```


```{r, eval=FALSE}

us_counties <- readRDS(gzcon(url("https://raw.githubusercontent.com/HimesGroup/BMIN503/master/DataFiles/uscounties_2010.rds")))

times_counties_data <- read.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")

times_state_data <- read.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")

covid_variables <- Provisional_COVID_19_Death_Counts_by_Sex_Age_and_State #Dataset from CDC

covid_variables_race <- Provisional_Death_Counts_for_Coronavirus_Disease_COVID_19_Distribution_of_Deaths_by_Race_and_Hispanic_Origin

```

```{r, eval=FALSE}

summary_df <- coronavirus %>% 
  filter(type == "confirmed") %>%
  filter(country == "US")

ggplot(data = summary_df, aes(x = date, y = cases)) +
      geom_bar(stat = "identity", fill = "pink") +
      labs(title = "US Confirmed Cases vs. Date",
           x = "Date", y = "New Reported Cases in the U.S.") 

```


```{r, eval=FALSE}

COVID_Cases_State <- times_counties_data %>%
  select(county, fips, cases, state) %>%
  group_by(county, fips, state) %>%
  summarise(total_cases = sum(cases))

COVID_Cases_State$county <- paste(COVID_Cases_State$county, "County")

COVID_Deaths_State <- times_counties_data %>%
  select(county, fips, deaths, state) %>%
  group_by(county, fips, state) %>%
  summarise(total_deaths = sum(deaths))

COVID_Deaths_State$county <- paste(COVID_Deaths_State$county, "County")

us_counties$county <- paste(us_counties$NAME, "County")

us_counties <- us_counties %>%
  select(-NAME)

```

```{r, eval=FALSE}

Cases <- inner_join(COVID_Cases_State, us_counties, by="county")

Cases <- Cases %>%
  select(county, state, GEO_ID, CENSUSAREA, geometry, total_cases, fips)

Deaths <-  inner_join(COVID_Deaths_State, us_counties, by="county")
Deaths <- Deaths %>%
  select(county, state, GEO_ID, CENSUSAREA, geometry, total_deaths, fips)

```

```{r, eval=FALSE}

summary(Cases$total_cases)

pal_fun <- colorBin(palette = brewer.pal(9, "RdBu")[c(1:5, 7)], 
                    bins = c(0, 10000, 17467, 35000, 52984, 100000, 157300, 1000000, 3000000, 23821196), reverse = TRUE,
                    NULL)

message <- paste0(Cases$county,", ", Cases$state,   
                     "<br>Total Cases by County: ",
                  Cases$total_cases)

leaflet(st_as_sf(Cases)) %>%
   addPolygons(stroke = FALSE,                        
               fillColor = ~pal_fun(total_cases),
               fillOpacity = 0.5, smoothFactor = 0.5, 
               popup = message) %>%
   addProviderTiles(providers$CartoDB.Positron) %>%   
   addLegend("bottomright",                           
             pal=pal_fun,                             
             values=~total_cases,               
             title = 'Total Cases',                  
             opacity = 1) %>%                         
   addScaleBar()

```

```{r, eval=FALSE}

summary(Deaths$total_deaths)

pal_fun <- colorBin(palette = brewer.pal(9, "RdBu")[c(1:5, 7)], 
                    bins = c(0, 300, 1000, 3000, 6000, 15000, 300000), reverse = TRUE,
                    NULL)

message <- paste0(Cases$county,", ", Deaths$state,   
                     "<br>Total Deaths by County: ",
                  Deaths$total_deaths)

leaflet(st_as_sf(Deaths)) %>%
   addPolygons(stroke = FALSE,                        
               fillColor = ~pal_fun(total_deaths),
               fillOpacity = 0.5, smoothFactor = 0.5, 
               popup = message) %>%
   addProviderTiles(providers$CartoDB.Positron) %>%   
   addLegend("bottomright",                           
             pal=pal_fun,                             
             values=~total_deaths,               
             title = 'Total Deaths',                  
             opacity = 1) %>%                         
   addScaleBar()


```

```{r, eval=FALSE}

linear_regression_df <- COVID_Cases_State %>%
  select(state, total_cases) %>%
  group_by(state) %>%
  summarise(Total_State_Cases = sum(total_cases))

second_linear_regressiondf <- COVID_Deaths_State %>%
  select(state, total_deaths) %>%
  group_by(state) %>%
  summarise(Total_State_Deaths = sum(total_deaths))

linear_regression <- inner_join(linear_regression_df, second_linear_regressiondf, by="state")

ggplot(linear_regression, aes(x = Total_State_Cases, y = Total_State_Deaths, color = state)) +
    geom_point(color = "blue") + 
    geom_smooth(method = "lm", color = "red")

summary.lm(lm(Total_State_Cases ~ Total_State_Deaths, data = linear_regression))

```

```{r, eval=FALSE}

covid_variables <- dplyr::rename(covid_variables, Age_group = 'Age group', COVID_Deaths = 'COVID-19 Deaths')

covid_sex_age_deaths <- covid_variables %>%
  select(Sex, Age_group, COVID_Deaths ) %>%
  filter(Sex == "Female" | Sex == "Male") %>%
  filter(Age_group != "All Ages" ) %>%
  na.omit()

covid_sex_age_deaths$Sex <- as.factor(covid_sex_age_deaths$Sex) 

ggplot(data = covid_sex_age_deaths, aes(x = Age_group, fill = factor(Sex))) + 
    geom_bar(position = "dodge") +
    facet_grid(. ~ Sex) 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r, eval = FALSE}
library(ggplot2)

covid_variables_race <- covid_variables_race %>%
  select("Non-Hispanic White", "Non-Hispanic Black or African American", "Non-Hispanic American Indian or Alaska Native", "Non-Hispanic Asian", "Non-Hispanic Native Hawaiian or Other Pacific Islander","Hispanic or Latino", "Other" )

covid_variables_race <- covid_variables_race[1, ]

covid_variables_race_new <-as.data.frame(t(covid_variables_race))

covid_variables_race_new <- dplyr::rename(covid_variables_race_new, Total_COVID_Deaths = "V1")

Race <- c("Non-Hispanic White", "Non-Hispanic Black or African American", "Non-Hispanic American Indian or Alaska Native", "Non-Hispanic Asian", "Non-Hispanic Native Hawaiian or Other Pacific Islander","Hispanic or Latino", "Other")
Covid_race_deaths <- c(124965, 45187, 2435, 9050, 428, 47038, 2094)

race_deaths <- cbind(Race, Covid_race_deaths)

race_deaths$Covid_race_deaths <- as.numeric(race_deaths$Covid_race_deaths)

summary(race_deaths)

ggplot(data = race_deaths, aes(x = Race)) + #Load data, specify variables
    geom_bar() #Add a visual layer that is a barplot


```


```{r, eval=FALSE}

suppressMessages(library(EpiModel))

control <- control.icm(type = "SIR", nsteps = 120, nsims = 10)

init <- init.icm(s.num = 10000, i.num = 3, r.num = 0)

param <- param.icm(inf.prob = 0.25, act.rate = 10, rec.rate = 0.04)

sim <- icm(param, init, control)

sim

plot(sim)

plot(sim, y = "si.flow", mean.col = "red", qnts.col = "red")

```

```{r, eval=FALSE}

incidence_rates <- as.data.frame(sim, out = "mean") %>% 
  select(time, si.flow, i.num) 

case_dates <- incidence_rates %>%
  select(time, si.flow) %>%
  pull(time)

```


### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
